# Recording Consumer - Dev Environment
# Kubernetes configuration for GKE Autopilot

# ğŸ–¼ï¸ Image Configuration
image:
  repository: us-east1-docker.pkg.dev/ritual-app-dev-104fc/docker/recording_consumer
  # tag is injected by CI/CD during rendering
  pullPolicy: Always

# ğŸ“Š Scaling
replicaCount: 1

resources:
  requests:
    cpu: 1000m
    memory: 2Gi
  limits:
    cpu: 1000m
    memory: 2Gi

# ğŸ”„ Autoscaling
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# ğŸ›¡ï¸ Pod Disruption Budget
podDisruptionBudget:
  enabled: false

# ğŸŒ Service (Internal - ClusterIP only)
service:
  type: ClusterIP
  port: 8080
  targetPort: 8080
  annotations: {}

# ğŸŒ Gateway API Configuration
gateway:
  enabled: false  # No public gateway
  
  # ğŸ“š Additional routes for Swagger Gateway (IAP-protected)
  # Access swagger UI at: swagger.dev.ourritual.com/recording-consumer/swagger
  additionalRoutes:
    - name: swagger
      gatewayName: swagger-gateway
      gatewayNamespace: dev
      hosts:
        - swagger.dev.ourritual.com
      pathMatch:
        type: PathPrefix
        value: /recording-consumer
      # No urlRewrite - pass through as-is

# ğŸš« NO Ingress (Internal service)
ingress:
  enabled: false

# ğŸš« NO Managed Certificate (Internal service)
managedCertificate:
  enabled: false

# âš™ï¸ Backend Config for IAP (Swagger Gateway)
backendConfig:
  enabled: true
  
  # ğŸ”’ IAP Configuration for Swagger Access
  iap:
    enabled: true
    clientID: "1065179748589-1fcsfo37foa6ghcf5dao83t9el4qqk4k.apps.googleusercontent.com"
    oauthSecretName: swagger-iap-oauth
  
  # ğŸ“Œ Session Affinity
  sessionAffinity:
    affinityType: CLIENT_IP
    affinityCookieTtlSec: 3600
  
  # â±ï¸ Timeout
  timeoutSec: 30

# ğŸŒ Environment Variables
env:
  - name: PORT
    value: "8080"
  - name: PROJECT_ID
    value: ritual-app-dev-104fc
  - name: GCP_PROJECT_ID
    value: ritual-app-dev-104fc
  - name: ENVIRONMENT
    value: dev
  - name: REGION
    value: us-east1

# â„¹ï¸  All other environment variables (Pub/Sub topics, subscriptions, etc.)
# are automatically synced from GCP Secret Manager and Parameter Manager
# via External Secrets Operator

# ğŸ” Secrets
# Secrets are automatically synced by External Secrets Operator
# This dummy entry ensures envFrom is rendered in deployment.yaml
secrets:
  - name: _managed_by_external_secrets_operator
    value: "true"

# GCP Project (for reference only)
gcpProject: ritual-app-dev-104fc

# ğŸ” External Secrets Operator Configuration
# Automatically syncs secrets from GCP Secret Manager to Kubernetes
externalSecrets:
  enabled: true
  gcpProjectID: ritual-app-dev-104fc
  clusterName: ritual-engine-dev
  clusterLocation: us-east1
  refreshInterval: 1h
  
  # Dedicated K8s SA for External Secrets Operator to fetch secrets
  serviceAccount:
    create: true
    name: recording-consumer-eso-sa
    annotations:
      # This GCP SA has secret-level IAM permissions (managed by Terraform)
      iam.gke.io/gcp-service-account: recording-consumer-secrets-sa@ritual-app-dev-104fc.iam.gserviceaccount.com
  
  # Secrets to sync from GCP Secret Manager
  secretNames:
    - recording-consumer
    - common-secrets

# ğŸ­ Service Account (Workload Identity) - For Pod Runtime
serviceAccount:
  create: true
  name: recording-consumer-sa
  annotations:
    # This GCP SA is for application runtime (Pub/Sub, logging, monitoring)
    # Managed by Terraform: cloud_infrastructure/environment/dev/ai/main.tf
    iam.gke.io/gcp-service-account: recording-consumer-sa@ritual-app-dev-104fc.iam.gserviceaccount.com

# ğŸ”’ Pod Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# ğŸ”’ Container Security Context
containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  capabilities:
    drop:
      - ALL

# â¤ï¸ Health Checks
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 30

# ğŸ·ï¸ Labels
app: recording-consumer
component: consumer
tier: backend
team: backend
environment: dev

# ğŸ“ Annotations
annotations: {}
