# Recording Webhook - External Secrets Configuration Example
# This shows how to configure External Secrets Operator integration
# Merge this with your existing values.yaml

# üîê External Secrets Operator Configuration
externalSecrets:
  enabled: true  # Set to true to enable External Secrets
  
  # GCP Configuration (matches Terraform output)
  gcpProjectID: ritual-app-dev-104fc
  gcpServiceAccount: "recording-webhook-secrets-sa@ritual-app-dev-104fc.iam.gserviceaccount.com"
  
  # GKE Cluster Configuration
  clusterName: ritual-gke-dev-autopilot
  clusterLocation: us-east1
  
  # Secret refresh interval
  refreshInterval: "1h"  # Sync from GCP every hour
  
  # Secrets to fetch from GCP Secret Manager
  # This service can ONLY access these secrets (enforced by Terraform IAM)
  secretNames:
    - recording-webhook-config
    # - common-config  # Optionally add shared secrets
  
  # Optional: Fine-grained secret mappings (if you need specific keys only)
  # secretMappings:
  #   - gcpSecretName: recording-webhook-config
  #     gcpSecretKey: database_url  # Specific key from JSON secret
  #     kubernetesKey: DATABASE_URL  # Rename in K8s
  #   - gcpSecretName: recording-webhook-config
  #     gcpSecretKey: api_key
  #     kubernetesKey: API_KEY

# üåç Environment Variables
# When externalSecrets.enabled=true, most env vars come from GCP Secret Manager
# Only K8s-specific overrides should be hardcoded here
env:
  - name: PORT
    value: "8080"
  - name: PROJECT_ID
    value: ritual-app-dev-104fc
  - name: GCP_PROJECT_ID  # Required by some libraries
    value: ritual-app-dev-104fc
  - name: ENVIRONMENT
    value: dev
  - name: LOG_LEVEL
    value: DEBUG
  - name: REGION
    value: us-east1

# üîê Secrets (OLD METHOD - REMOVED when using External Secrets)
# When externalSecrets.enabled=true, this should be empty or minimal
secrets:
  # Keep a dummy entry to ensure envFrom is rendered in deployment
  - name: _managed_by_external_secrets_operator
    value: "true"

# üé≠ Service Account (Workload Identity)
# This K8s SA is bound to the GCP SA via Terraform
serviceAccount:
  create: true
  name: recording-webhook-sa
  annotations:
    iam.gke.io/gcp-service-account: recording-webhook-sa@ritual-app-dev-104fc.iam.gserviceaccount.com

# GCP Project (for reference)
gcpProject: ritual-app-dev-104fc

# üñºÔ∏è Image Configuration
image:
  repository: us-east1-docker.pkg.dev/ritual-app-dev-104fc/docker/recording_webhook
  pullPolicy: Always

# üìä Scaling
replicaCount: 1

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 512Mi

# üîÑ Autoscaling
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# üåê Service
service:
  type: ClusterIP
  port: 8080
  targetPort: 8080

# üöÄ Gateway API
gateway:
  enabled: true
  staticIPName: "dev-ingress-ip"
  redirectHTTPS: true
  hosts:
    - host: recording-webhook.dev.ourritual.com

# üè∑Ô∏è Labels & Metadata
app: recording-webhook
component: webhook
team: backend
tier: api

# üîç Probes
livenessProbe:
  enabled: true
  httpGet:
    path: /
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  httpGet:
    path: /
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  enabled: true
  httpGet:
    path: /
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30

# üîí Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  capabilities:
    drop:
      - ALL

