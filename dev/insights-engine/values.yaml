# insights-engine - Dev Environment
# Kubernetes configuration for the insights-engine service

# ğŸ–¼ï¸ Image Configuration
image:
  repository: us-east1-docker.pkg.dev/ritual-app-dev-104fc/docker/insights-engine
  # tag is injected by CI/CD during rendering
  pullPolicy: Always

# ğŸ“Š Scaling
replicaCount: 1

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 2Gi # From Cloud Run config

# ğŸ”„ Autoscaling
autoscaling:
  enabled: false # Temporarily disabled - keeping at 1 replica for debugging
  minReplicas: 1
  maxReplicas: 10 # From Cloud Run config
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# ğŸ›¡ï¸ Pod Disruption Budget
podDisruptionBudget:
  enabled: false

# ğŸŒ Service (internal only)
service:
  type: ClusterIP
  port: 8080
  targetPort: 8080
  annotations: {}

# ğŸŒ Gateway API Configuration
gateway:
  enabled: false  # No public gateway
  
  # ğŸ“š Additional routes for Swagger Gateway (IAP-protected)
  # Access swagger UI at: swagger.dev.ourritual.com/insights-engine/swagger
  additionalRoutes:
    - name: swagger
      gatewayName: swagger-gateway
      gatewayNamespace: dev
      hosts:
        - swagger.dev.ourritual.com
      pathMatch:
        type: PathPrefix
        value: /insights-engine
      # No urlRewrite - pass through as-is

# âš™ï¸ Backend Config for IAP (Swagger Gateway)
backendConfig:
  enabled: true
  
  # ğŸ”’ IAP Configuration for Swagger Access
  iap:
    enabled: true
    clientID: "1065179748589-1fcsfo37foa6ghcf5dao83t9el4qqk4k.apps.googleusercontent.com"
    oauthSecretName: swagger-iap-oauth
  
  # ğŸ“Œ Session Affinity
  sessionAffinity:
    affinityType: CLIENT_IP
    affinityCookieTtlSec: 3600
  
  # â±ï¸ Timeout
  timeoutSec: 30

# ğŸ” External Secrets Operator Configuration
externalSecrets:
  enabled: true
  gcpProjectID: ritual-app-dev-104fc
  clusterName: ritual-engine-dev # Ensure this matches your GKE cluster name
  clusterLocation: us-east1
  refreshInterval: 1h
  
  serviceAccount:
    create: true
    name: insights-engine-eso-sa
    annotations:
      iam.gke.io/gcp-service-account: insights-engine-secrets-sa@ritual-app-dev-104fc.iam.gserviceaccount.com
  
  secretNames:
    - insights-engine
    - common-secrets

# ğŸ­ Service Account (Workload Identity) - For Pod Runtime
serviceAccount:
  create: true
  name: insights-engine-sa
  annotations:
    iam.gke.io/gcp-service-account: insights-engine-sa@ritual-app-dev-104fc.iam.gserviceaccount.com

# ğŸ”’ Pod Security Context
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# ğŸ”’ Container Security Context
containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  capabilities:
    drop:
      - ALL

# â¤ï¸ Health Checks
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Readiness probe temporarily disabled due to application bug:
# Error: 'State' object has no attribute 'publisher'
# TODO: Fix the /ready endpoint in the application code
readinessProbe:
  httpGet:
    path: /health  # Using /health instead of /ready as workaround
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  failureThreshold: 60 # Allow up to 5 minutes for startup

# ğŸ“ Environment Variables (non-secret)
env:
  - name: PORT
    value: "8080"
  - name: PROJECT_ID
    value: ritual-app-dev-104fc
  - name: GCP_PROJECT_ID
    value: ritual-app-dev-104fc
  - name: ENVIRONMENT
    value: dev
  - name: LOG_LEVEL
    value: INFO
  - name: REGION
    value: us-east1
  # Add other non-secret environment variables here if needed

# â„¹ï¸ Secrets are automatically synced by External Secrets Operator
# The secret "insights-engine-microservice-secrets" is managed by:
# - ExternalSecret CRD: insights-engine-microservice-config (in dev namespace)
# - Source: GCP Secret Manager secret "insights-engine" and "common-secrets"
# - Refresh: Every 1 hour
#
# This dummy entry ensures envFrom is rendered in deployment.yaml.
# The actual secret content is populated by ExternalSecret, not by these values.
secrets:
  - name: _managed_by_external_secrets_operator
    value: "true"

# GCP Project (for reference only, not used for secret fetching)
gcpProject: ritual-app-dev-104fc


